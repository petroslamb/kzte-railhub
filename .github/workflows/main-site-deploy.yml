name: Deploy Main Site

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    name: Build and publish main site
    runs-on: ubuntu-latest
    env:
      APP_DIR: railhub-demo
      SITE_ROOT: site
      NEXT_BASE_PATH: /${{ github.event.repository.name }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        if: ${{ hashFiles('railhub-demo/package.json') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: railhub-demo/package-lock.json

      - name: Install dependencies
        if: ${{ hashFiles('railhub-demo/package.json') != '' }}
        run: |
          set -euo pipefail
          if npm ci; then
            exit 0
          fi
          echo "npm ci failed; retrying with npm install" >&2
          npm install
        working-directory: ${{ env.APP_DIR }}

      - name: Build export bundle
        if: ${{ hashFiles('railhub-demo/package.json') != '' }}
        run: |
          npm run build --if-present
          npm run export --if-present
        working-directory: ${{ env.APP_DIR }}
        env:
          NEXT_PUBLIC_BASE_PATH: ${{ env.NEXT_BASE_PATH }}

      - name: Prepare static artefacts
        run: |
          set -euo pipefail
          rm -rf "${SITE_ROOT}"
          mkdir -p "${SITE_ROOT}"
          if [ -d "${APP_DIR}/out" ]; then
            rsync -a --delete "${APP_DIR}/out/" "${SITE_ROOT}/"
          elif [ -d "${APP_DIR}/dist" ]; then
            rsync -a --delete "${APP_DIR}/dist/" "${SITE_ROOT}/"
          elif [ -d "${APP_DIR}/build" ]; then
            rsync -a --delete "${APP_DIR}/build/" "${SITE_ROOT}/"
          else
            python3 - "$SITE_ROOT" -c $'from pathlib import Path\nimport sys\nfrom textwrap import dedent\nsite_root = Path(sys.argv[1])\nsite_root.mkdir(parents=True, exist_ok=True)\nhtml = dedent("""<!DOCTYPE html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"utf-8\" />\n    <title>KZTE RailHub Main</title>\n    <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" />\n    <style>\n      body { font-family: system-ui, sans-serif; margin: 2.5rem auto; max-width: 60ch; line-height: 1.6; padding: 0 1.5rem; }\n      h1 { font-size: 2rem; margin-bottom: 1rem; }\n      code { background: #f4f4f4; padding: 0.15rem 0.35rem; border-radius: 0.25rem; }\n      a { color: #2563eb; }\n    </style>\n  </head>\n  <body>\n    <h1>Main branch deployment placeholder</h1>\n    <p>No build artefacts were produced in this run. Ensure the Next.js export emits an <code>out/</code> directory.</p>\n  </body>\n</html>\n""")\nsite_root.joinpath("index.html").write_text(html, encoding="utf-8")\n'
          fi
          touch "${SITE_ROOT}/.nojekyll"

      - name: Publish to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ${{ env.SITE_ROOT }}
          keep_files: true
          user_name: github-actions[bot]
          user_email: 41898282+github-actions[bot]@users.noreply.github.com
          commit_message: "docs: deploy main site @ ${{ github.sha }}"
